<!DOCTYPE html>
<html>
<head>
    <title>LiveKit Connection Test</title>
    <script type="module">
        import { Room, RoomEvent } from 'https://unpkg.com/livekit-client@2.15.7/dist/livekit-client.esm.mjs';
        
        window.LiveKitRoom = Room;
        window.LiveKitRoomEvent = RoomEvent;
        window.livekitLoaded = true;
    </script>
</head>
<body>
    <h1>LiveKit Connection Test</h1>
    <button onclick="testConnection()">Test Connection</button>
    <div id="output"></div>

    <script>
        const LIVEKIT_URL = 'wss://belllive-9f7u9uab.livekit.cloud';
        const BACKEND_URL = 'https://bell-app-6bdo.onrender.com';

        async function waitForLiveKit() {
            while (!window.livekitLoaded) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function testConnection() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Starting connection test...</p>';

            try {
                // Wait for LiveKit to load
                await waitForLiveKit();
                output.innerHTML += '<p>‚úÖ LiveKit library loaded</p>';

                // Generate token
                console.log('Requesting token...');
                const response = await fetch(`${BACKEND_URL}/api/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roomName: 'test-room',
                        participantName: 'test-user'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Token request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('Token received:', typeof data.token);
                console.log('Token value:', data.token);
                output.innerHTML += `<p>‚úÖ Token received (${typeof data.token}, length: ${data.token.length})</p>`;

                // Validate token format
                const tokenParts = data.token.split('.');
                if (tokenParts.length !== 3) {
                    throw new Error(`Invalid JWT format - expected 3 parts, got ${tokenParts.length}`);
                }
                output.innerHTML += '<p>‚úÖ Token format validated (3 parts)</p>';

                // Create room with minimal configuration
                const room = new window.LiveKitRoom({
                    adaptiveStream: false,
                    dynacast: false,
                });

                // Add connection event listeners
                room.on(window.LiveKitRoomEvent.Connected, () => {
                    console.log('‚úÖ Connected successfully!');
                    output.innerHTML += '<p>‚úÖ Connected successfully!</p>';
                });

                room.on(window.LiveKitRoomEvent.Disconnected, (reason) => {
                    console.log('‚ùå Disconnected:', reason);
                    output.innerHTML += `<p>‚ùå Disconnected: ${reason}</p>`;
                });

                room.on(window.LiveKitRoomEvent.ConnectionStateChanged, (state) => {
                    console.log('Connection state:', state);
                    output.innerHTML += `<p>Connection state: ${state}</p>`;
                });

                // Attempt connection
                console.log('Connecting to LiveKit...');
                console.log('URL:', LIVEKIT_URL);
                console.log('Token preview:', data.token.substring(0, 100) + '...');
                output.innerHTML += '<p>üîå Connecting to LiveKit...</p>';
                
                await room.connect(LIVEKIT_URL, data.token);
                
            } catch (error) {
                console.error('Connection failed:', error);
                output.innerHTML += `<p>‚ùå Connection failed: ${error.message}</p>`;
                
                // Additional error details
                if (error.cause) {
                    output.innerHTML += `<p>‚ùå Error cause: ${error.cause}</p>`;
                }
                if (error.stack) {
                    console.error('Full error stack:', error.stack);
                }
            }
        }
    </script>
</body>
</html>